{% extends 'admin/layout.html' %}
{% block title %}Historial de Notificaciones{% endblock %}
{% block admin_content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Historial de Notificaciones</h2>
</div>
<form method="get" class="row g-3 mb-3">
  <div class="col-md-3">
    <select class="form-select" name="raffle_id">
      <option value="">Todas las rifas</option>
      {% for r in raffles %}
        <option value="{{ r.id }}" {% if raffle_id and raffle_id==r.id %}selected{% endif %}>{{ r.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <select class="form-select" name="buyer_id">
      <option value="">Todos los compradores</option>
      {% for b in buyers %}
        <option value="{{ b.id }}" {% if buyer_id and buyer_id==b.id %}selected{% endif %}>{{ b.nombre }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-4">
    <input type="text" class="form-control" name="q" placeholder="Buscar por mensaje" value="{{ q if q else '' }}">
  </div>
  <div class="col-md-2">
    <button type="submit" class="btn btn-primary">Filtrar</button>
  </div>
</form>
<div class="table-responsive">
  <table class="table table-striped align-middle">
    <thead class="table-light">
      <tr>
        <th>ID</th>
        <th>Rifa</th>
        <th>Comprador</th>
        <th>Mensaje</th>
        <th>Enviado</th>
      </tr>
    </thead>
    <tbody>
      {% for n in notifications.items %}
      <tr>
        <td>{{ n.id }}</td>
        <td>{{ raffle_map.get(n.raffle_id).name if raffle_map.get(n.raffle_id) else '' }}</td>
        <td>{{ buyer_map.get(n.buyer_id).nombre if buyer_map.get(n.buyer_id) else '' }}</td>
        <td>{{ n.message }}</td>
        <td>{{ n.sent_at.strftime('%Y-%m-%d %H:%M') if n.sent_at else '' }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
<nav>
  <ul class="pagination">
    {% if notifications.has_prev %}
      <li class="page-item"><a class="page-link" href="{{ url_for('admin.notifications_log', page=notifications.prev_num, raffle_id=request.args.get('raffle_id',''), buyer_id=request.args.get('buyer_id',''), q=request.args.get('q','')) }}">Anterior</a></li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Anterior</span></li>
    {% endif %}
    <li class="page-item disabled"><span class="page-link">PÃ¡gina {{ notifications.page }} de {{ notifications.pages }}</span></li>
    {% if notifications.has_next %}
      <li class="page-item"><a class="page-link" href="{{ url_for('admin.notifications_log', page=notifications.next_num, raffle_id=request.args.get('raffle_id',''), buyer_id=request.args.get('buyer_id',''), q=request.args.get('q','')) }}">Siguiente</a></li>
    {% else %}
      <li class="page-item disabled"><span class="page-link">Siguiente</span></li>
    {% endif %}
  </ul>
</nav>
{% endblock %}
