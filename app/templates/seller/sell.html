{% extends 'seller/layout.html' %}
{% block title %}Vender Boletas{% endblock %}
{% block seller_content %}
<div class="container mt-4 pb-5">
  <h2>Venta de Boletas</h2>
  {% set selected_raffle = (raffles | selectattr('id', 'equalto', selected_raffle_id | int) | list | first) %}
  {% if selected_raffle %}
  <div class="card mb-4 shadow-sm">
    <div class="row g-0">
      {% if selected_raffle.imagen %}
      <div class="col-md-4 d-flex align-items-center justify-content-center">
        {% if selected_raffle.imagen.startswith('http') %}
          <img src="{{ selected_raffle.imagen }}" class="img-fluid rounded-start" alt="Imagen de la rifa" style="max-height:220px; max-width:100%; object-fit:contain;">
        {% else %}
          <img src="{{ url_for('static', filename=selected_raffle.imagen) }}" class="img-fluid rounded-start" alt="Imagen de la rifa" style="max-height:220px; max-width:100%; object-fit:contain;">
        {% endif %}
      </div>
      {% endif %}
      <div class="col-md-8">
        <div class="card-body">
          <h5 class="card-title">{{ selected_raffle.name }}</h5>
          <p class="card-text mb-1"><strong>Valor:</strong> ${{ selected_raffle.valor }}</p>
          <p class="card-text mb-1"><strong>Fecha caducidad:</strong> {{ selected_raffle.fecha_caducidad.strftime('%d/%m/%Y') if selected_raffle.fecha_caducidad else 'Sin fecha' }}</p>
          <p class="card-text mb-1"><strong>Lotería:</strong> {{ selected_raffle.loteria }}</p>
          <p class="card-text">{{ selected_raffle.descripcion }}</p>
        </div>
      </div>
    </div>
  </div>
  <form method="POST">
    <input type="hidden" name="raffle_id" value="{{ selected_raffle.id }}">
    <div class="row">
      <div class="mb-3 col-md-6">
        <label for="buyer_name" class="form-label">Nombre del Comprador</label>
        <div class="position-relative">
          <input type="text" autocomplete="off" class="form-control text-uppercase" id="buyer_name" name="buyer_name" required style="text-transform:uppercase;">
          <div id="buyer_suggestions" class="list-group position-absolute w-100" style="z-index:1050; display:none;"></div>
        </div>
      </div>
      <div class="mb-3 col-md-6">
        <label for="buyer_email" class="form-label">Email del Comprador</label>
        <input type="email" class="form-control text-uppercase" id="buyer_email" name="buyer_email" required style="text-transform:uppercase;">
      </div>
    </div>
    <div class="row">
      <div class="mb-3 col-md-6">
        <label for="buyer_phone" class="form-label">Teléfono</label>
        <input type="text" class="form-control text-uppercase" id="buyer_phone" name="buyer_phone" required style="text-transform:uppercase;">
      </div>
      <div class="mb-3 col-md-6">
        <label for="buyer_address" class="form-label">Dirección</label>
        <input type="text" class="form-control text-uppercase" id="buyer_address" name="buyer_address" required style="text-transform:uppercase;">
      </div>
    </div>
    <div class="row">
      <div class="mb-3 col-md-6">
        <label for="boletas" class="form-label">Selecciona los números de boleta</label>
        <select class="form-select" id="boletas" name="boletas" multiple required style="width:100%; min-height:38px;"></select>
        <div class="mt-1">
          <span id="boletas_count" class="badge bg-primary"></span>
        </div>
      </div>
      <div class="mb-3 col-md-6">
        <label class="form-label">Total a pagar</label>
        <div id="total_pagar" class="p-2 bg-info text-white rounded">$0</div>
      </div>
    </div>
    <div class="row">
      <div class="mb-3 col-md-6">
        <label for="payment_method" class="form-label">Método de Pago</label>
        <select class="form-select" id="payment_method" name="payment_method" required>
          <option value="PSE">PSE -Nequi</option>
          <option value="Efectivo">Efectivo</option>
          <option value="Cuotas">Cuotas</option>
        </select>
      </div>
      <div class="mb-3 col-md-6"></div>
    </div>
    <div class="row">
      <hr class="my-4 border-3 border-primary rounded-pill" style="opacity:0.5;">
      <div class="col-12 d-flex justify-content-start">
        <button type="submit" class="btn btn-success">Vender</button>
      </div>
    </div>
  </form>
  {% endif %}

<script>
  // Autocomplete buyer by name
  (function(){
    const input = document.getElementById('buyer_name');
    const suggestions = document.getElementById('buyer_suggestions');
    let timer = null;
    input.addEventListener('input', function(){
      const q = this.value.trim();
      clearTimeout(timer);
      if(!q){ suggestions.style.display='none'; return; }
      timer = setTimeout(()=>{
        fetch(`/seller/buyer_search?q=${encodeURIComponent(q)}`)
          .then(r=>r.json())
          .then(data=>{
            suggestions.innerHTML='';
            if(!data || data.length===0){ suggestions.style.display='none'; return; }
            data.forEach(b=>{
              const item = document.createElement('button');
              item.type = 'button';
              item.className = 'list-group-item list-group-item-action';
              item.textContent = `${b.nombre} — ${b.email}`;
              item.addEventListener('click', ()=>{
                document.getElementById('buyer_name').value = b.nombre;
                document.getElementById('buyer_email').value = b.email || '';
                document.getElementById('buyer_phone').value = b.telefono || '';
                document.getElementById('buyer_address').value = b.direccion || '';
                suggestions.style.display='none';
              });
              suggestions.appendChild(item);
            });
            suggestions.style.display='block';
          }).catch(()=>{ suggestions.style.display='none'; });
      }, 300);
    });
    // Hide on outside click
    document.addEventListener('click', function(e){ if(!suggestions.contains(e.target) && e.target!==input) suggestions.style.display='none'; });
  })();

    // Forzar mayúsculas al escribir en los campos de texto
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.text-uppercase').forEach(function(input) {
        input.addEventListener('input', function() {
          this.value = this.value.toUpperCase();
        });
      });
    });
  // Diccionario de boletas disponibles por rifa (inyectado desde Jinja)
  const boletasPorRifa = {{ boletas_por_rifa|tojson }};
  const boletasSelect = document.getElementById('boletas');
  const boletasCount = document.getElementById('boletas_count');
  const rafflesData = {{ raffles_json|tojson }};
  const totalPagar = document.getElementById('total_pagar');
  const selectedRaffleId = '{{ selected_raffle_id }}';

  function actualizarBoletas() {
    const raffleId = selectedRaffleId;
    const boletas = boletasPorRifa[raffleId] || [];
    boletasSelect.innerHTML = '';
    boletas.forEach(num => {
      const option = document.createElement('option');
      option.value = num;
      option.textContent = num;
      boletasSelect.appendChild(option);
    });
    if (window.jQuery && window.$.fn.select2) {
      if ($(boletasSelect).data('select2')) {
        $(boletasSelect).off('change').select2('destroy');
      }
      $(boletasSelect).select2({
        placeholder: 'Buscar y seleccionar números',
        width: '100%',
        allowClear: true,
        dropdownCssClass: 'select2-bootstrap-5',
        selectionCssClass: 'select2--large'
      }).on('change', function() {
        const count = $(this).val() ? $(this).val().length : 0;
        boletasCount.textContent = count > 0 ? `Seleccionados: ${count}` : 'Selecciona uno o varios números.';
        // Calcular total
        let valor = 0;
        for (let i = 0; i < rafflesData.length; i++) {
          if (rafflesData[i].id == raffleId) {
            valor = rafflesData[i].valor;
            break;
          }
        }
        totalPagar.textContent = `$${count * valor}`;
      });
      boletasCount.textContent = 'Selecciona uno o varios números.';
      totalPagar.textContent = '$0';
    }
  }

  function cargarSelect2YArrancar() {
    // Cargar estilos de Bootstrap 5 para Select2
    const bs5link = document.createElement('link');
    bs5link.rel = 'stylesheet';
    bs5link.href = 'https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css';
    document.head.appendChild(bs5link);
    if (!window.jQuery || !window.$.fn.select2) {
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = 'https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css';
      document.head.appendChild(link);
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js';
      script.onload = function() {
        const script2 = document.createElement('script');
        script2.src = 'https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js';
        script2.onload = function() {
          actualizarBoletas();
        };
        document.body.appendChild(script2);
      };
      document.body.appendChild(script);
    } else {
      actualizarBoletas();
    }
  }

  // Inicializar al cargar la página
  window.addEventListener('DOMContentLoaded', cargarSelect2YArrancar);
</script>
</div>
{% endblock %}
